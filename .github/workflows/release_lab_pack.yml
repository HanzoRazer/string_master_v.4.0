name: Release Lab Pack

on:
  push:
    tags:
      - "v*"
      - "labpack-*"
      - "reaper-bundle-*"

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  determinism-test:
    name: Determinism Test (Ubuntu builds twice)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build #1
        run: |
          rm -rf dist
          python scripts/release/build_lab_pack.py
          python scripts/release/make_release_metadata.py
          ZIP1="$(ls -1 dist/Lab_Pack_SG_*.zip | head -n 1)"
          SHA1="$(cat "${ZIP1}.sha256" | awk '{print $1}')"
          echo "ZIP1=$ZIP1" >> $GITHUB_ENV
          echo "SHA1=$SHA1" >> $GITHUB_ENV
        shell: bash

      - name: Build #2
        run: |
          rm -rf dist
          python scripts/release/build_lab_pack.py
          python scripts/release/make_release_metadata.py
          ZIP2="$(ls -1 dist/Lab_Pack_SG_*.zip | head -n 1)"
          SHA2="$(cat "${ZIP2}.sha256" | awk '{print $1}')"
          echo "ZIP2=$ZIP2" >> $GITHUB_ENV
          echo "SHA2=$SHA2" >> $GITHUB_ENV
        shell: bash

      - name: Policy check zip contents (preflight)
        run: |
          python scripts/release/check_lab_pack_policy.py
        shell: bash

      - name: Assert deterministic
        run: |
          echo "SHA1=$SHA1"
          echo "SHA2=$SHA2"
          if [ "$SHA1" != "$SHA2" ]; then
            echo "ERROR: Lab Pack zip is NOT deterministic on the same runner."
            exit 1
          fi
          echo "OK: deterministic (sha256 matches)."
        shell: bash

      - name: Structure lint (zip)
        run: |
          python scripts/release/lint_lab_pack_zip.py
        shell: bash
        env:
          CI_TAG: ${{ github.ref_name }}

  build-lab-pack:
    name: Build Lab Pack (${{ matrix.os }})
    needs: [determinism-test]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build Lab Pack zip + metadata
        run: |
          python --version
          python scripts/release/build_lab_pack.py
          python scripts/release/make_release_metadata.py
          ls -lah dist
        shell: bash

      - name: Policy check zip contents
        run: |
          python scripts/release/check_lab_pack_policy.py
        shell: bash

      - name: Structure lint (zip)
        run: |
          python scripts/release/lint_lab_pack_zip.py
        shell: bash
        env:
          CI_TAG: ${{ github.ref_name }}

      - name: Verify outputs exist
        run: |
          ZIP_PATH="$(ls -1 dist/Lab_Pack_SG_*.zip | head -n 1)"
          test -n "$ZIP_PATH"
          test -f "${ZIP_PATH}.sha256"
          test -f "${ZIP_PATH}.manifest.txt"
        shell: bash

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lab-pack-tag-${{ matrix.os }}
          path: |
            dist/Lab_Pack_SG_*.zip
            dist/Lab_Pack_SG_*.zip.sha256
            dist/Lab_Pack_SG_*.zip.manifest.txt
          if-no-files-found: error
          retention-days: 14

  guard-compare-builds:
    name: Guard - Compare OS builds
    runs-on: ubuntu-latest
    needs: [build-lab-pack]

    steps:
      - name: Download Ubuntu artifacts
        uses: actions/download-artifact@v4
        with:
          name: lab-pack-tag-ubuntu-latest
          path: artifacts/ubuntu

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: lab-pack-tag-windows-latest
          path: artifacts/windows

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: lab-pack-tag-macos-latest
          path: artifacts/macos

      - name: Normalize and compare manifests + sha256
        run: |
          set -euo pipefail

          U_MAN="$(ls -1 artifacts/ubuntu/*.manifest.txt | head -n 1)"
          W_MAN="$(ls -1 artifacts/windows/*.manifest.txt | head -n 1)"
          M_MAN="$(ls -1 artifacts/macos/*.manifest.txt | head -n 1)"

          U_SHA="$(ls -1 artifacts/ubuntu/*.sha256 | head -n 1)"
          W_SHA="$(ls -1 artifacts/windows/*.sha256 | head -n 1)"
          M_SHA="$(ls -1 artifacts/macos/*.sha256 | head -n 1)"

          # Normalize CRLF just in case (Windows)
          tr -d '\r' < "$U_MAN" > /tmp/u.man
          tr -d '\r' < "$W_MAN" > /tmp/w.man
          tr -d '\r' < "$M_MAN" > /tmp/m.man

          tr -d '\r' < "$U_SHA" > /tmp/u.sha
          tr -d '\r' < "$W_SHA" > /tmp/w.sha
          tr -d '\r' < "$M_SHA" > /tmp/m.sha

          echo "Comparing manifests..."
          diff -u /tmp/u.man /tmp/w.man
          diff -u /tmp/u.man /tmp/m.man

          echo "Comparing sha256..."
          diff -u /tmp/u.sha /tmp/w.sha
          diff -u /tmp/u.sha /tmp/m.sha

          echo "OK: OS builds match (manifest + sha256 identical)."

  verify-ubuntu-artifacts:
    name: Verify Ubuntu artifacts (SHA + cosign bundle) before publish
    runs-on: ubuntu-latest
    needs: [guard-compare-builds]
    permissions:
      id-token: write  # needed for cosign verification in some environments
      attestations: write  # needed for attestation verification
      contents: read

    steps:
      - name: Checkout (for verify_release.sh script)
        uses: actions/checkout@v4

      - name: Download Ubuntu artifacts
        uses: actions/download-artifact@v4
        with:
          name: lab-pack-tag-ubuntu-latest
          path: verify/dist

      - name: List downloaded artifacts
        run: |
          set -euo pipefail
          ls -lah verify/dist
        shell: bash

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Create Sigstore bundle (sign-blob)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          set -euo pipefail
          cd verify/dist
          ZIP="$(ls -1 Lab_Pack_SG_*.zip | head -n 1)"
          cosign sign-blob "$ZIP" --yes --bundle "${ZIP}.sigstore.json"
          test -f "${ZIP}.sigstore.json"
        shell: bash

      - name: Run offline verification (sha256 + cosign bundle)
        run: |
          set -euo pipefail
          cd verify/dist

          # Ensure verifier is executable
          chmod +x ../../scripts/release/verify_release.sh

          # Run verifier in-place (no download needed; uses local files)
          ../../scripts/release/verify_release.sh --no-gh
        shell: bash

      - name: Verify required release-side metadata exists (best-effort)
        run: |
          set -euo pipefail
          cd verify/dist

          ZIP="$(ls -1 Lab_Pack_SG_*.zip | head -n 1)"
          test -f "${ZIP}.sha256"
          test -f "${ZIP}.manifest.txt"
          test -f "${ZIP}.sigstore.json"

          echo "OK: metadata present"
        shell: bash

      - name: Verify GitHub CLI available
        run: |
          gh --version
        shell: bash

      - name: Verify GitHub attestations exist and verify (policy-aware)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ATTEST_STRICT: "false"   # set to "true" if your org wants hard enforcement
          ATTEST_OWNER: ${{ github.repository_owner }}
          ATTEST_REPO: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          chmod +x scripts/release/verify_attestations.sh
          scripts/release/verify_attestations.sh "verify/dist/Lab_Pack_SG_*.zip"
        shell: bash

      - name: Assert verifier artifacts + bundles exist (11.7.2 mandatory)
        run: |
          set -euo pipefail
          for f in \
            scripts/release/verify_release.sh \
            scripts/release/verify_release.ps1 \
            scripts/release/verify_attestations.sh
          do
            test -f "$f"
            test -f "${f}.sigstore.json"
          done
          echo "OK: verifier scripts and bundles present"
        shell: bash

      - name: Cosign verify verifiers (bundle → verifier)
        run: |
          set -euo pipefail
          cosign version
          cosign verify-blob --bundle scripts/release/verify_release.sh.sigstore.json scripts/release/verify_release.sh >/dev/null
          cosign verify-blob --bundle scripts/release/verify_release.ps1.sigstore.json scripts/release/verify_release.ps1 >/dev/null
          cosign verify-blob --bundle scripts/release/verify_attestations.sh.sigstore.json scripts/release/verify_attestations.sh >/dev/null
          echo "OK: verifier cosign bundle verification passed"
        shell: bash

      - name: Verify verifier GitHub attestations (STRICT - 11.7.3)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          chmod +x scripts/release/verify_verifier_attestations_strict.sh
          scripts/release/verify_verifier_attestations_strict.sh \
            --owner "${{ github.repository_owner }}" \
            --repo "${{ github.event.repository.name }}"
        shell: bash

      - name: Policy receipts (runtime + canonical) — ZIP + verifiers
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p dist/receipts/runtime dist/receipts/canonical

          # ZIP
          python scripts/release/attestation_policy_engine.py \
            --subject "verify/dist/Lab_Pack_SG_*.zip" \
            --repo "${{ github.repository }}" \
            --tag "${{ github.ref_name }}" \
            --policy scripts/release/attestation_policy.json \
            --schema scripts/release/attestation_schema_min.json \
            --profile lab_pack_zip \
            --attestation-type provenance \
            --canonicalize \
            --receipt-runtime-out dist/receipts/runtime/policy_receipt_zip.runtime.json \
            --receipt-canonical-out dist/receipts/canonical/policy_receipt_zip.canonical.json

          # Verifiers
          for s in \
            scripts/release/verify_release.sh \
            scripts/release/verify_release.ps1 \
            scripts/release/verify_attestations.sh
          do
            if [ -f "$s" ]; then
              base="$(basename "$s")"
              python scripts/release/attestation_policy_engine.py \
                --subject "$s" \
                --repo "${{ github.repository }}" \
                --tag "${{ github.ref_name }}" \
                --policy scripts/release/attestation_policy.json \
                --schema scripts/release/attestation_schema_min.json \
                --profile verifiers \
                --attestation-type provenance \
                --canonicalize \
                --receipt-runtime-out "dist/receipts/runtime/policy_receipt_${base}.runtime.json" \
                --receipt-canonical-out "dist/receipts/canonical/policy_receipt_${base}.canonical.json"
            fi
          done

          echo "Receipts:"
          ls -lah dist/receipts/runtime dist/receipts/canonical
        shell: bash

      - name: Sign canonical receipts (cosign bundle)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          set -euo pipefail
          chmod +x scripts/release/sign_policy_receipt.sh
          for r in dist/receipts/canonical/*.json; do
            scripts/release/sign_policy_receipt.sh "$r"
          done
          ls -lah dist/receipts/canonical
        shell: bash

      - name: Upload policy receipts (runtime + canonical + bundles)
        uses: actions/upload-artifact@v4
        with:
          name: policy-receipts-verified
          path: |
            dist/receipts/runtime/*.json
            dist/receipts/canonical/*.json
            dist/receipts/canonical/*.json.sigstore.json
          if-no-files-found: error
          retention-days: 14

      - name: Upload verified assets (ubuntu)
        uses: actions/upload-artifact@v4
        with:
          name: lab-pack-verified-ubuntu
          path: verify/dist/*
          if-no-files-found: error
          retention-days: 14

  publish-ubuntu-only:
    name: Publish Release (Ubuntu asset only)
    runs-on: ubuntu-latest
    needs: [determinism-test, guard-compare-builds, verify-ubuntu-artifacts]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download verified Ubuntu artifacts
        uses: actions/download-artifact@v4
        with:
          name: lab-pack-verified-ubuntu
          path: dist

      - name: Download policy receipts
        uses: actions/download-artifact@v4
        with:
          name: policy-receipts-verified
          path: dist/receipts

      - name: Find Lab Pack assets
        id: find_assets
        run: |
          ZIP_PATH="$(ls -1 dist/Lab_Pack_SG_*.zip | head -n 1)"
          SHA_PATH="${ZIP_PATH}.sha256"
          MAN_PATH="${ZIP_PATH}.manifest.txt"

          test -n "$ZIP_PATH"
          test -f "$SHA_PATH"
          test -f "$MAN_PATH"

          echo "zip_path=$ZIP_PATH" >> "$GITHUB_OUTPUT"
          echo "sha_path=$SHA_PATH" >> "$GITHUB_OUTPUT"
          echo "man_path=$MAN_PATH" >> "$GITHUB_OUTPUT"

      - name: Generate release notes (bundle + checksums)
        run: |
          python scripts/release/generate_release_notes.py "${{ steps.find_assets.outputs.zip_path }}"
          ls -lah dist
        shell: bash

      - name: Generate provenance + SBOM (SPDX)
        run: |
          python scripts/release/generate_provenance_and_sbom.py
          test -f dist/provenance.json
          test -f dist/labpack.spdx.json
          ls -lah dist
        shell: bash

      - name: Assert verifier bundles exist (required by 11.7.2)
        run: |
          set -euo pipefail
          for f in \
            scripts/release/verify_release.sh \
            scripts/release/verify_release.ps1 \
            scripts/release/verify_attestations.sh
          do
            if [ -f "$f" ]; then
              if [ ! -f "${f}.sigstore.json" ]; then
                echo "ERR: Verifier bundle missing: ${f}.sigstore.json"
                exit 1
              fi
              echo "✓ Bundle exists: ${f}.sigstore.json"
            fi
          done
          echo "OK: All verifier bundles present"
        shell: bash

      - name: Generate verifier SBOM (SPDX)
        run: |
          python scripts/release/generate_verifier_sbom.py
          test -f dist/verifiers.spdx.json
          ls -lah dist
        shell: bash

      - name: Install Cosign (for verifier signing)
        uses: sigstore/cosign-installer@v3

      - name: Cosign sign verifiers (keyless, bundle files)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          set -euo pipefail
          for f in \
            scripts/release/verify_release.sh \
            scripts/release/verify_release.ps1 \
            scripts/release/verify_attestations.sh
          do
            if [ -f "$f" ]; then
              cosign sign-blob "$f" --yes --bundle "${f}.sigstore.json"
              test -f "${f}.sigstore.json"
              echo "✓ Signed: ${f}"
            fi
          done
          ls -lah scripts/release/*.sigstore.json
        shell: bash

      - name: Verify sigstore bundle exists (created by verify job)
        run: |
          ZIP_PATH="${{ steps.find_assets.outputs.zip_path }}"
          test -f "${ZIP_PATH}.sigstore.json"
          echo "✓ Sigstore bundle verified: ${ZIP_PATH}.sigstore.json"
          ls -lah dist
        shell: bash

      - name: Attest build provenance (GitHub)
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: ${{ steps.find_assets.outputs.zip_path }}

      - name: Attest SBOM (GitHub)
        uses: actions/attest-sbom@v1
        with:
          subject-path: ${{ steps.find_assets.outputs.zip_path }}
          sbom-path: dist/labpack.spdx.json

      - name: Generate verifier SBOMs (one per subject)
        run: |
          python scripts/release/generate_verifier_sboms_per_subject.py
          ls -lah dist/verifiers
        shell: bash

      - name: Attest build provenance (verify_release.sh)
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: scripts/release/verify_release.sh

      - name: Attest build provenance (verify_release.ps1)
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: scripts/release/verify_release.ps1

      - name: Attest build provenance (verify_attestations.sh)
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: scripts/release/verify_attestations.sh

      - name: Attest SBOM (verify_release.sh)
        uses: actions/attest-sbom@v1
        with:
          subject-path: scripts/release/verify_release.sh
          sbom-path: dist/verifiers/verify_release.sh.spdx.json

      - name: Attest SBOM (verify_release.ps1)
        uses: actions/attest-sbom@v1
        with:
          subject-path: scripts/release/verify_release.ps1
          sbom-path: dist/verifiers/verify_release.ps1.spdx.json

      - name: Attest SBOM (verify_attestations.sh)
        uses: actions/attest-sbom@v1
        with:
          subject-path: scripts/release/verify_attestations.sh
          sbom-path: dist/verifiers/verify_attestations.sh.spdx.json

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          body_path: dist/release_notes.md
          files: |
            ${{ steps.find_assets.outputs.zip_path }}
            ${{ steps.find_assets.outputs.sha_path }}
            ${{ steps.find_assets.outputs.man_path }}
            dist/provenance.json
            dist/labpack.spdx.json
            dist/verifiers.spdx.json
            dist/verifiers/*.spdx.json
            ${{ steps.find_assets.outputs.zip_path }}.sigstore.json
            scripts/release/verify_release.sh
            scripts/release/verify_release.ps1
            scripts/release/verify_attestations.sh
            scripts/release/verify_release.sh.sigstore.json
            scripts/release/verify_release.ps1.sigstore.json
            scripts/release/verify_attestations.sh.sigstore.json
            scripts/release/attestation_policy_engine.py
            scripts/release/attestation_policy.json
            scripts/release/attestation_schema_min.json
            dist/receipts/runtime/*.json
            dist/receipts/canonical/*.json
            dist/receipts/canonical/*.json.sigstore.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  post-publish-external-verify:
    name: Post-publish external verification (download release assets)
    runs-on: ubuntu-latest
    needs: [publish-ubuntu-only]
    permissions:
      contents: read
      id-token: write
      attestations: write

    steps:
      - name: Checkout (for verifier scripts)
        uses: actions/checkout@v4

      - name: Verify GitHub CLI available
        run: |
          gh --version
        shell: bash

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Download release assets (external consumer mode)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          mkdir -p external_verify
          cd external_verify

          echo "Downloading from release: ${REPO} tag=${TAG}"

          # Download all assets for the tag release
          gh release download "${TAG}" --repo "${REPO}" --dir .

          echo "Downloaded files:"
          ls -lah

          # Assert we got the expected core assets
          ZIP="$(ls -1 Lab_Pack_SG_*.zip | head -n 1)"
          test -n "$ZIP"
          test -f "${ZIP}.sha256"
          test -f "${ZIP}.sigstore.json"

          # Optional assets (soft-check if Phase 11 publishes them)
          test -f "provenance.json" || echo "WARN: provenance.json missing"
          test -f "labpack.spdx.json" || echo "WARN: labpack.spdx.json missing"

          echo "OK: required assets present"
        shell: bash

      - name: Assert verifier bundle policy (11.7.2)
        run: |
          set -euo pipefail
          cd external_verify
          
          for f in verify_release.sh verify_release.ps1 verify_attestations.sh; do
            if [ -f "$f" ]; then
              if [ ! -f "${f}.sigstore.json" ]; then
                echo "ERR: Policy violation - verifier present but bundle missing: ${f}"
                exit 1
              fi
              echo "✓ Policy OK: ${f} has bundle"
            fi
          done
          
          echo "OK: Verifier bundle policy satisfied"
        shell: bash

      - name: Verify release assets (SHA + cosign bundle)
        run: |
          set -euo pipefail
          chmod +x scripts/release/verify_release.sh
          cd external_verify
          ../scripts/release/verify_release.sh --no-gh
        shell: bash

      - name: Verify GitHub attestations (policy-aware)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ATTEST_STRICT: "false"   # set to "true" to enforce hard-fail if policy blocks
          ATTEST_OWNER: ${{ github.repository_owner }}
          ATTEST_REPO: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          chmod +x scripts/release/verify_attestations.sh
          scripts/release/verify_attestations.sh "external_verify/Lab_Pack_SG_*.zip"
        shell: bash

      - name: Summary
        run: |
          echo "✅ Post-publish external verification succeeded"
          echo "   - Downloaded assets from GitHub Release"
          echo "   - Verified SHA256 checksum"
          echo "   - Verified cosign bundle"
          echo "   - Verified GitHub attestations (or soft-skipped on policy block)"
          echo ""
          echo "Release assets are verifiable by external consumers."
        shell: bash

  cold-machine-simulation:
    name: Cold machine simulation (container, no checkout)
    runs-on: ubuntu-latest
    needs: [publish-ubuntu-only]
    permissions:
      contents: read
      id-token: write
      attestations: write

    container:
      image: alpine:3.19

    steps:
      - name: Install tools (curl, bash, cosign, gh)
        env:
          GH_VERSION: "2.56.0"
          COSIGN_VERSION: "2.4.1"
        run: |
          set -euo pipefail
          apk add --no-cache ca-certificates curl bash jq coreutils
          update-ca-certificates

          # Install gh (static-ish tarball)
          curl -fsSL -o /tmp/gh.tgz "https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz"
          tar -xzf /tmp/gh.tgz -C /tmp
          mv /tmp/gh_${GH_VERSION}_linux_amd64/bin/gh /usr/local/bin/gh

          # Install cosign
          curl -fsSL -o /usr/local/bin/cosign "https://github.com/sigstore/cosign/releases/download/v${COSIGN_VERSION}/cosign-linux-amd64"
          chmod +x /usr/local/bin/cosign

          gh --version
          cosign version
        shell: bash

      - name: Download release assets (including verifiers)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          mkdir -p work
          cd work

          echo "Downloading assets from release: ${REPO} ${TAG}"
          gh auth login --with-token <<< "${GITHUB_TOKEN}" >/dev/null 2>&1 || true

          # Download everything from the release
          gh release download "${TAG}" --repo "${REPO}" --dir .

          echo "Downloaded:"
          ls -lah

          # Assert Lab Pack core assets exist
          ZIP="$(ls -1 Lab_Pack_SG_*.zip | head -n 1)"
          test -n "$ZIP"
          test -f "${ZIP}.sha256"
          test -f "${ZIP}.sigstore.json"

          # Assert verifiers were uploaded as release assets
          test -f "verify_release.sh"
          chmod +x verify_release.sh

          echo "OK: assets present"
        shell: bash

      - name: Verify verifier scripts (cosign bundle)
        run: |
          set -euo pipefail
          cd work

          # Verify verifiers exist
          for f in verify_release.sh verify_attestations.sh; do
            test -f "$f"
          done

          # Verify verifier bundles exist
          test -f "verify_release.sh.sigstore.json"
          test -f "verify_attestations.sh.sigstore.json"

          # Verify verifier signatures
          cosign verify-blob --bundle verify_release.sh.sigstore.json verify_release.sh
          cosign verify-blob --bundle verify_attestations.sh.sigstore.json verify_attestations.sh

          # Verify PowerShell verifier (if present)
          if [ -f "verify_release.ps1" ]; then
            test -f "verify_release.ps1.sigstore.json"
            cosign verify-blob --bundle verify_release.ps1.sigstore.json verify_release.ps1
          fi

          echo "✓ Verifier scripts verified (cosign bundles)"
        shell: bash

      - name: Assert per-subject verifier SBOMs present
        run: |
          set -euo pipefail
          cd work
          test -f "verify_release.sh.spdx.json" || echo "WARN: verify_release.sh.spdx.json missing"
          test -f "verify_release.ps1.spdx.json" || echo "WARN: verify_release.ps1.spdx.json missing"
          test -f "verify_attestations.sh.spdx.json" || echo "WARN: verify_attestations.sh.spdx.json missing"
          echo "✓ Per-subject verifier SBOMs checked"
        shell: bash

      - name: Verify (SHA + cosign bundle) using release-sourced verifier
        run: |
          set -euo pipefail
          cd work
          # Use strict pin mode to ensure verifier integrity
          ./verify_release.sh --no-gh --pin strict --pin-file provenance.json
        shell: bash

      - name: Verify attestations (release-sourced verifier, policy-aware)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ATTEST_STRICT: "false"   # set true to enforce hard-fail
          ATTEST_OWNER: ${{ github.repository_owner }}
          ATTEST_REPO: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          cd work

          # Use the verifier fetched from the release (treat as external)
          if [ -f verify_attestations.sh ]; then
            chmod +x verify_attestations.sh
            ./verify_attestations.sh "Lab_Pack_SG_*.zip"
          else
            echo "WARN: verify_attestations.sh not present; doing direct gh verify"
            ZIP="$(ls -1 Lab_Pack_SG_*.zip | head -n 1)"
            gh attestation verify "$ZIP" --owner "${ATTEST_OWNER}"
          fi
        shell: bash

      - name: Strict attestation verify (verifiers + zip - 11.7.3)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
        run: |
          set -euo pipefail
          cd work

          # Verify verifier attestations (maximum strictness)
          gh attestation verify verify_release.sh --owner "$OWNER" >/dev/null
          gh attestation verify verify_attestations.sh --owner "$OWNER" >/dev/null
          gh attestation verify verify_release.ps1 --owner "$OWNER" >/dev/null
          echo "✓ Verifier attestations verified"

          # Verify the Lab Pack zip itself
          ZIP="$(ls -1 Lab_Pack_SG_*.zip | head -n 1)"
          gh attestation verify "$ZIP" --owner "$OWNER" >/dev/null
          echo "✓ Lab Pack attestation verified"

          echo "OK: strict attestation verification passed (verifiers + zip)"
        shell: bash

      - name: Policy engine gate - ZIP (cold-machine - 11.7.4.b)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          cd work
          
          python3 attestation_policy_engine.py \
            --subject "Lab_Pack_SG_*.zip" \
            --repo "$REPO" \
            --tag "$TAG" \
            --policy attestation_policy.json \
            --schema attestation_schema_min.json \
            --profile lab_pack_zip \
            --attestation-type provenance
        shell: bash

      - name: Verify policy receipt signatures (cold-machine - 11.7.5)
        run: |
          set -euo pipefail
          cd work
          
          # Verify all receipt signatures exist and validate
          for r in *.receipt.json; do
            test -f "${r}.sigstore.json" || { echo "Missing bundle: ${r}.sigstore.json"; exit 1; }
            cosign verify-blob --bundle "${r}.sigstore.json" "$r"
            echo "✓ Receipt signature verified: $r"
          done
          
          echo "OK: all policy receipts cryptographically verified"
        shell: bash

      - name: Policy engine gate - Verifiers (cold-machine - 11.7.4.b)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          cd work
          
          for s in verify_release.sh verify_release.ps1 verify_attestations.sh; do
            if [ -f "$s" ]; then
              python3 attestation_policy_engine.py \
                --subject "$s" \
                --repo "$REPO" \
                --tag "$TAG" \
                --policy attestation_policy.json \
                --schema attestation_schema_min.json \
                --profile verifiers \
                --attestation-type provenance
            fi
          done
        shell: bash
          gh attestation verify verify_release.ps1 --owner "$OWNER" >/dev/null
          echo "✓ Verifier attestations verified"

          # Verify the Lab Pack zip itself
          ZIP="$(ls -1 Lab_Pack_SG_*.zip | head -n 1)"
          gh attestation verify "$ZIP" --owner "$OWNER" >/dev/null
          echo "✓ Lab Pack attestation verified"

          echo "OK: strict attestation verification passed (verifiers + zip)"
        shell: bash

      - name: Cold machine simulation success
        run: |
          echo "✅ Cold machine simulation passed"
          echo "   - Minimal container (Alpine 3.19, no checkout)"
          echo "   - Downloaded all assets from GitHub Release"
          echo "   - Verified using release-sourced verifier scripts"
          echo "   - SHA256 checksum: OK"
          echo "   - Cosign bundle: OK"
          echo "   - Verifier pin check: OK (strict mode)"
          echo "   - Verifier bundle pin: OK (strict mode)"
          echo "   - Verifier attestations: OK (strict - 11.7.3)"
          echo "   - Lab Pack attestation: OK (strict)"
          echo "   - Policy engine: OK (allowlists enforced - 11.7.4.b)"
          echo ""
          echo "Release is fully verifiable in cold environment with maximum strictness + policy enforcement."
        shell: bash
