{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://zone-tritone.dev/schemas/ztex.schema.json",
  "title": "Zone-Tritone Exercise (.ztex)",
  "description": "Schema for Zone-Tritone exercise files defining practice tasks, prompts, and assessment criteria. Supports three usage patterns: simple (task/interaction), phrase (goals/assessment), and pack (multi-program pedagogy).",
  "type": "object",
  "required": ["id"],
  "anyOf": [
    { "required": ["name"] },
    { "required": ["title"] }
  ],
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier for this exercise."
    },
    "name": {
      "type": "string",
      "description": "Human-readable exercise name (used in simple exercises)."
    },
    "title": {
      "type": "string",
      "description": "Display title (used in phrase and pack exercises)."
    },
    "program_ref": {
      "type": "string",
      "description": "Relative path to the backing .ztprog file (singular)."
    },
    "program_refs": {
      "type": "array",
      "description": "Array of paths to associated .ztprog files (multi-program packs).",
      "items": { "type": "string" }
    },
    "exercise_type": {
      "type": "string",
      "description": "Exercise type identifier (e.g., 'phrase_accuracy', 'lead_phrase', 'scale_fluency')."
    },
    "level": {
      "type": "string",
      "description": "Difficulty level identifier (e.g., 'A', 'B', 'C')."
    },
    "category": {
      "type": "string",
      "description": "Exercise category (e.g., 'cadence', 'groove', 'voicing')."
    },
    "concept": {
      "type": "string",
      "description": "Musical concept being practiced."
    },
    "goals": {
      "type": "array",
      "description": "Learning objectives for this exercise.",
      "items": { "type": "string" }
    },
    "practice_steps": {
      "type": "array",
      "description": "Ordered practice steps.",
      "items": { "type": "string" }
    },
    "tags": {
      "description": "Searchable tags. Array of strings (pack style) or object with key-value pairs (phrase style).",
      "oneOf": [
        {
          "type": "array",
          "items": { "type": "string" }
        },
        {
          "type": "object",
          "additionalProperties": true
        }
      ]
    },
    "assessment": {
      "$ref": "#/definitions/assessmentSpec"
    },
    "task": {
      "$ref": "#/definitions/taskSpec"
    },
    "interaction": {
      "$ref": "#/definitions/interactionSpec"
    },
    "quick_map": {
      "type": "object",
      "description": "Quick reference mapping keys to progressions.",
      "additionalProperties": { "type": "string" }
    },
    "voicing_families": {
      "type": "array",
      "description": "Voicing options grouped by family/style.",
      "items": { "$ref": "#/definitions/voicingFamily" }
    },
    "rhythm": {
      "type": "object",
      "description": "Rhythm and feel guidance.",
      "properties": {
        "feel": { "type": "string" },
        "tips": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": true
    },
    "listening_cues": {
      "type": "array",
      "description": "Self-assessment listening prompts.",
      "items": { "type": "string" }
    }
  },
  "additionalProperties": true,
  "definitions": {
    "assessmentSpec": {
      "type": "object",
      "description": "Assessment criteria. Supports two formats: pass_condition (qualitative) or what_to_measure + pass_criteria (quantitative).",
      "properties": {
        "pass_condition": {
          "type": "array",
          "description": "Qualitative conditions for successful completion.",
          "items": { "type": "string" }
        },
        "what_to_measure": {
          "type": "array",
          "description": "Quantitative metrics to assess.",
          "items": { "type": "string" }
        },
        "pass_criteria": {
          "type": "object",
          "description": "Threshold values for measured metrics.",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "taskSpec": {
      "type": "object",
      "description": "Task specification for practice.",
      "properties": {
        "mode": {
          "type": "string",
          "description": "Task mode (e.g., 'play_roots', 'play_shells', 'improvise')."
        },
        "instructions": {
          "type": "string",
          "description": "Main instruction text for the student."
        },
        "prompts": {
          "type": "array",
          "description": "Additional prompts and guidance.",
          "items": { "type": "string" }
        }
      }
    },
    "interactionSpec": {
      "type": "object",
      "description": "Interaction and feedback configuration.",
      "properties": {
        "mode": {
          "type": "string",
          "description": "Interaction mode (e.g., 'self_report', 'auto_detect')."
        },
        "questions": {
          "type": "array",
          "description": "Reflection questions for self-assessment.",
          "items": { "type": "string" }
        }
      }
    },
    "voicingFamily": {
      "type": "object",
      "description": "A family of related voicings.",
      "properties": {
        "name": {
          "type": "string",
          "description": "Family name."
        },
        "idea": {
          "oneOf": [
            { "type": "string" },
            { "type": "array", "items": { "type": "string" } }
          ],
          "description": "Core voicing idea or approach."
        },
        "examples": {
          "type": "object",
          "description": "Example voicings by key.",
          "additionalProperties": {
            "type": "object",
            "additionalProperties": { "type": "string" }
          }
        }
      }
    }
  }
}
