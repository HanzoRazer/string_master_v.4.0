# sg_agentd Handoff — 2026-02-02

**Engineer**: GitHub Copilot (Claude Opus 4.5)  
**Scope**: Phase 3 + Phase 4.1 implementation of `sg_agentd` — FastAPI daemon for agentic MIDI generation  
**Status**: ✅ Complete — 21 tests passing

---

## Executive Summary

`sg_agentd` is a FastAPI microservice that wraps `zt-band` (the MIDI generation engine) with an agentic retry loop. It exposes a `/generate` endpoint that accepts structured generation requests and returns MIDI artifacts with full provenance.

**Key capabilities delivered:**
- Deterministic seed derivation from `request_id` (reproducibility without explicit seeds)
- Pitch range validation with configurable limits
- Attempt loop with budget control and short-circuit on success
- Full artifact bundle (clip.mid, clip.tags.json, clip.runlog.json)

---

## Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│  POST /generate                                                  │
│  GenerationRequest (Pydantic)                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  run_attempt_loop()                                              │
│  ├── derive seed from request_id (if not explicit)              │
│  ├── call generate_accompaniment(seed=N)                        │
│  ├── validate_pitch_range(comp, bass, limit)                    │
│  ├── if passed → return "ok"                                    │
│  ├── if failed → retry with next seed (up to budget)            │
│  └── if budget exhausted → return "partial" or "failed"         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  write_clip_bundle_default()                                     │
│  ├── clip.mid (MIDI file)                                        │
│  ├── clip.tags.json (metadata)                                   │
│  └── clip.runlog.json (execution trace)                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  GenerationResult                                                │
│  ├── status: "ok" | "partial" | "failed"                        │
│  ├── artifacts: [MidiArtifact, JsonArtifact, ...]               │
│  ├── validation_report: {passed, violations, warnings}          │
│  └── run_log: {duration_ms, attempts_used, seed_used, ...}      │
└─────────────────────────────────────────────────────────────────┘
```

---

## File Inventory

### Core Module: `src/sg_agentd/`

| File | Lines | Purpose |
|------|-------|---------|
| `__init__.py` | 15 | Package exports |
| `server.py` | ~280 | FastAPI app, `/generate` endpoint, bundle writing |
| `schemas.py` | ~200 | Pydantic models: GenerationRequest, GenerationResult, artifacts |
| `seed.py` | ~80 | Deterministic seed derivation from request_id |
| `loop.py` | ~160 | Attempt loop orchestrator with validation |
| `validators/__init__.py` | ~20 | Validators package exports |
| `validators/range.py` | ~105 | Pitch range constraint validation |

### Tests: `tests/`

| File | Tests | Purpose |
|------|-------|---------|
| `test_sg_agentd_generate.py` | 8 | Phase 3: endpoint, schemas, determinism |
| `test_sg_agentd_loop.py` | 13 | Phase 4: seed, range, loop orchestration |

---

## Key Design Decisions

### 1. Seed Derivation Strategy

**Problem**: Probabilistic mode + `require_determinism=True` + no explicit seed — what to do?

**Phase 3 approach** (rejected): Return `DETERMINISM_VIOLATION` error.

**Phase 4 approach** (implemented): Derive seed from `request_id` using SHA256:
```python
def derive_base_seed(request_id: UUID) -> int:
    h = hashlib.sha256(request_id.bytes).digest()
    return int.from_bytes(h[:4], "big") % (MAX_SEED + 1)
```

**Rationale**: Same `request_id` → same seed → same output. Determinism is always satisfiable.

### 2. Attempt Seed Progression

Each retry uses a different seed derived from the base:
```python
def derive_attempt_seed(base_seed: int, attempt_index: int) -> int:
    return (base_seed + attempt_index) % (MAX_SEED + 1)
```

This ensures retries explore different random states while remaining deterministic.

### 3. Loop Outcome Semantics

| Status | Meaning | Selected Attempt |
|--------|---------|------------------|
| `"ok"` | An attempt passed validation | First passing attempt |
| `"partial"` | Budget exhausted, but candidates exist | First candidate (best effort) |
| `"failed"` | All attempts crashed (no output) | None |

### 4. Pitch Range Validation

Default limit: 24 semitones (2 octaves). Configurable via:
```json
{
  "constraints": {
    "pitch_range_limit": 36
  }
}
```

Validation checks `max(all_notes) - min(all_notes) <= limit`.

---

## Request/Response Contract

### GenerationRequest (abbreviated)

```json
{
  "schema_id": "generation_request",
  "schema_version": "v1",
  "request_id": "uuid",
  "harmony": {
    "chord_symbols": ["Dm7", "G7", "Cmaj7"],
    "bars_per_chord": 1
  },
  "style": {
    "style_name": "swing_basic",
    "tempo_bpm": 120
  },
  "tritone": {
    "mode": "none" | "deterministic" | "probabilistic",
    "seed": 12345
  },
  "constraints": {
    "attempt_budget": 5,
    "pitch_range_limit": 24,
    "require_determinism": true,
    "validate_contract": true
  }
}
```

### GenerationResult (abbreviated)

```json
{
  "schema_id": "generation_result",
  "schema_version": "v1",
  "request_id": "uuid",
  "status": "ok",
  "artifacts": [
    {"type": "midi", "filename": "clip.mid", "sha256": "..."},
    {"type": "json", "filename": "clip.tags.json", "sha256": "..."}
  ],
  "validation_report": {
    "passed": true,
    "violations": [],
    "warnings": []
  },
  "run_log": {
    "duration_ms": 1234,
    "attempts_used": 1,
    "seed_used": 987654321
  }
}
```

---

## Test Coverage

### Phase 3 Tests (8)
- `test_minimal_request_validates` — schema acceptance
- `test_missing_chord_symbols_fails` — validation rejection
- `test_probabilistic_without_seed_allowed_when_determinism_false`
- `test_health_check` — GET /health
- `test_generate_minimal_request` — happy path
- `test_determinism_derives_seed_when_missing` — **updated in Phase 4**
- `test_ok_result_validates` — result schema
- `test_failed_result_validates` — error result schema

### Phase 4 Tests (13)
- `test_same_request_id_produces_same_base_seed` — determinism
- `test_different_request_ids_produce_different_seeds`
- `test_attempt_seeds_vary_by_index`
- `test_choose_seed_honors_explicit_seed`
- `test_range_within_limit_passes`
- `test_range_exceeds_limit_fails`
- `test_empty_events_passes_with_warning`
- `test_loop_returns_ok_on_first_pass`
- `test_loop_exhausts_budget_on_failures`
- `test_loop_returns_failed_when_all_crash`
- `test_loop_uses_derived_seeds`
- `test_loop_short_circuits_on_success`
- `test_endpoint_reports_attempts_used` — integration

**Run all tests:**
```bash
cd string_master_v.4.0
python -m pytest tests/test_sg_agentd_generate.py tests/test_sg_agentd_loop.py -v
```

---

## Dependencies

`sg_agentd` imports from `zt_band` at runtime:
- `generate_accompaniment()` — core MIDI generation
- `write_clip_bundle_default()` — artifact bundle writer
- `BundleResult`, `ArtifactRef` — result types
- `NoteEvent` — for `.note` attribute in validation

These are lazy-imported in `server.py` via `_import_zt_band()` to allow graceful degradation.

---

## Next Steps (Phase 4.2+)

### Phase 4.2: Additional Validators
- `validators/duration.py` — max clip length constraint
- `validators/density.py` — notes-per-bar limits
- Validator registry pattern for composable constraints

### Phase 4.3: Critic Integration
- Add `CriticReport` to validation pipeline
- LLM-based quality assessment (optional, async)
- Critic feedback influences attempt selection

### Phase 4.4: Streaming/Webhooks
- Long-running generation with progress callbacks
- Webhook notification on completion
- Async job queue (Redis/Celery)

### Phase 5: Multi-Agent Orchestration
- Multiple generation strategies in parallel
- Best-of-N selection with critic ranking
- A/B testing infrastructure

---

## Running the Server

```bash
cd string_master_v.4.0
python -m sg_agentd.server
# Server runs on http://localhost:8420
```

**Health check:**
```bash
curl http://localhost:8420/health
```

**Generate request:**
```bash
curl -X POST http://localhost:8420/generate \
  -H "Content-Type: application/json" \
  -d @request.json
```

---

## Known Limitations

1. **No persistence**: Bundles written to temp directory by default. Production needs configured output path.

2. **Synchronous generation**: `/generate` blocks until complete. For long clips, consider async pattern.

3. **Single validator**: Only pitch range implemented. Other constraints (duration, density) pending.

4. **No rate limiting**: Production deployment needs throttling.

---

## Contact / Handoff Notes

- All code is in `src/sg_agentd/` and `tests/test_sg_agentd_*.py`
- No external state or database required
- Tests are self-contained with mocks for `zt_band` imports
- The `verify_lock.py` script validates core MIDI engine stability (separate from sg_agentd)

**Last verified:** 2026-02-02, 21 tests passing, Python 3.14.0
