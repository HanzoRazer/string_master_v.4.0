# Policy Receipts (Phase 11.7.5)

## Overview

**Policy receipts** provide **machine-readable, cryptographically signed proof** that a release passed attestation policy validation.

Every evaluated artifact (Lab Pack zip, verifier scripts) generates a receipt containing:
- **Subject** (artifact name + SHA256)
- **Policy profile** applied (allowlists + constraints)
- **Attestations evaluated** (digests + extracted fields)
- **Result** (pass/fail + reasons)
- **Run context** (repo, tag, workflow, run IDs)

Receipts are signed with Sigstore keyless (`cosign sign-blob`) to make them **tamper-evident** and **portable** for external auditors.

---

## Receipt Structure

```json
{
  "kind": "SmartGuitarAttestationPolicyReceipt",
  "policy_engine_version": "11.7.5",
  "profile": "lab_pack_zip",
  "repo": "OWNER/REPO",
  "tag": "v1.2.3",
  "ref": "refs/tags/v1.2.3",
  "subject": {
    "path": "verify/dist/Lab_Pack_SG_v1.2.3.zip",
    "name": "Lab_Pack_SG_v1.2.3.zip",
    "sha256": "abc123..."
  },
  "policy": {
    "policy_file": "scripts/release/attestation_policy.json",
    "schema_file": "scripts/release/attestation_schema_min.json",
    "expanded_allowlists": {
      "source_uri_allow_prefixes": ["git+https://github.com/..."],
      "workflow_path": [".github/workflows/release_lab_pack.yml"],
      "runner_environment_allow": ["github-hosted"]
    },
    "strict": {},
    "required_attestation_types": ["provenance"]
  },
  "gh": {
    "run_id": "1234567890",
    "run_attempt": "1",
    "workflow": "Release Lab Pack",
    "sha": "def456...",
    "repository": "OWNER/REPO",
    "server_url": "https://github.com"
  },
  "download": {
    "attestation_type_requested": "provenance",
    "download_dir": "/tmp/attestations/...",
    "downloaded_count": 1
  },
  "attestations": [
    {
      "attestation_file": "/tmp/attestations/abc123.json",
      "attestation_file_sha256": "ghi789...",
      "predicateType": "https://slsa.dev/provenance/v1",
      "extracted": {
        "configSource_uri": "git+https://github.com/OWNER/REPO@refs/tags/v1.2.3",
        "workflow_path": ".github/workflows/release_lab_pack.yml",
        "runner_environment": "github-hosted",
        "subject_digest": {"sha256": "abc123..."},
        "configSource_digest": {"sha1": "def456..."}
      },
      "schema_ok": true,
      "policy_ok": true,
      "fail_reason": "",
      "snippet": "..." // optional truncated attestation excerpt
    }
  ],
  "result": {
    "ok": true,
    "any_pass": true,
    "reasons": []
  }
}
```

---

## Receipt Files

For each evaluated artifact:

| File | Purpose |
|------|---------|
| `lab_pack.receipt.json` | Policy evaluation result (Lab Pack zip) |
| `lab_pack.receipt.json.sigstore.json` | Cosign keyless signature bundle |
| `verify_release.sh.receipt.json` | Policy evaluation result (verifier) |
| `verify_release.sh.receipt.json.sigstore.json` | Cosign signature bundle |

Receipts are:
- Generated by `attestation_policy_engine.py --receipt-out <path>`
- Signed by `sign_policy_receipt.sh <receipt.json>`
- Attached to GitHub Releases as audit artifacts
- Optionally attested with build provenance (GitHub Artifact Attestations)

---

## Workflow Integration

### Pre-publish Gate (verify-ubuntu-artifacts)

```yaml
- name: Policy engine gate + receipt - ZIP (11.7.5)
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: |
    python scripts/release/attestation_policy_engine.py \
      --subject "verify/dist/Lab_Pack_SG_*.zip" \
      --repo "${{ github.repository }}" \
      --tag "${{ github.ref_name }}" \
      --policy scripts/release/attestation_policy.json \
      --schema scripts/release/attestation_schema_min.json \
      --profile lab_pack_zip \
      --attestation-type provenance \
      --receipt-out policy_receipts/lab_pack.receipt.json \
      --receipt-mode single \
      --receipt-include-attestation-snippets
  shell: bash

- name: Sign policy receipts with cosign (11.7.5)
  run: |
    chmod +x scripts/release/sign_policy_receipt.sh
    for r in policy_receipts/*.receipt.json; do
      scripts/release/sign_policy_receipt.sh "$r"
    done
  shell: bash

- name: Upload policy receipts as artifacts
  uses: actions/upload-artifact@v4
  with:
    name: policy-receipts-ubuntu
    path: policy_receipts/*
    retention-days: 90
```

### Publish Job (attach receipts to release)

```yaml
- name: Download policy receipts (11.7.5)
  uses: actions/download-artifact@v4
  with:
    name: policy-receipts-ubuntu
    path: dist/policy_receipts

- name: Create GitHub Release and upload assets
  uses: softprops/action-gh-release@v2
  with:
    files: |
      ...
      dist/policy_receipts/*.receipt.json
      dist/policy_receipts/*.receipt.json.sigstore.json
```

### Cold Machine Verification

```yaml
- name: Verify policy receipt signatures (cold-machine - 11.7.5)
  run: |
    cd work
    for r in *.receipt.json; do
      cosign verify-blob --bundle "${r}.sigstore.json" "$r"
      echo "✓ Receipt signature verified: $r"
    done
  shell: bash
```

---

## Local Verification

**Step 1: Download release assets**

```bash
mkdir -p release-assets
gh release download v1.2.3 --dir release-assets
```

**Step 2: Verify receipt signatures**

```bash
make verify-receipts ASSETS=release-assets
```

Or manually:

```bash
cd release-assets
cosign verify-blob \
  --bundle lab_pack.receipt.json.sigstore.json \
  lab_pack.receipt.json
```

**Step 3: Inspect receipt contents**

```bash
jq '.result.ok' release-assets/lab_pack.receipt.json
jq '.attestations[].policy_ok' release-assets/lab_pack.receipt.json
```

---

## Receipt Modes

### Single Mode (default)

```bash
--receipt-mode single
```

Overwrites receipt file (one receipt per run).

**Use case:** Release gates (idempotent, latest evaluation wins)

### Append Mode

```bash
--receipt-mode append
```

Appends JSONL entry (newline-delimited JSON).

**Use case:** Audit trails (preserve all evaluations)

---

## Attestation Snippets

Include truncated attestation excerpts in receipts:

```bash
--receipt-include-attestation-snippets
```

**Behavior:**
- First 4000 chars of each attestation JSON (pretty-printed)
- Truncated with `...(truncated N chars)` suffix
- Safe for logs and human inspection
- Does NOT expose full attestation payloads

**Omit for minimal receipts:**
- Smaller files
- Only digests and extracted fields
- Full attestations still verifiable via `gh attestation verify`

---

## Security Properties

| Property | Mechanism |
|----------|-----------|
| **Integrity** | Cosign keyless signature (Rekor transparency log) |
| **Authenticity** | GitHub OIDC identity (workflow → certificate) |
| **Non-repudiation** | Rekor log entry (public audit trail) |
| **Portability** | JSON + .sigstore.json bundle (works offline after download) |
| **Determinism** | Same inputs → same receipt (reproducible evaluation) |

---

## Receipt Verification Workflow

```mermaid
graph TD
    A[Download release + receipts] --> B[Verify signatures with cosign]
    B --> C[Parse receipt JSON]
    C --> D{result.ok == true?}
    D -->|Yes| E[Check attestations[].policy_ok]
    D -->|No| F[Inspect result.reasons]
    E --> G{All attestations passed?}
    G -->|Yes| H[✓ Release OK]
    G -->|No| F
    F --> I[Audit failure]
```

---

## CI/CD Gates

### Pre-publish (must pass)

1. Policy engine evaluates attestations
2. Receipts generated (`--receipt-out`)
3. Receipts signed with cosign
4. Receipts uploaded as artifacts

### Publish (must attach)

1. Download receipts from artifacts
2. Attach receipts to GitHub Release

### Cold machine (must verify)

1. Download receipts from release
2. Verify signatures with cosign
3. Optional: Re-evaluate policy and compare receipts

---

## Audit Use Cases

### Compliance Team

```bash
# Download and verify receipts
gh release download v1.2.3 --dir audit
cd audit
cosign verify-blob --bundle lab_pack.receipt.json.sigstore.json lab_pack.receipt.json

# Check result
jq '.result.ok' lab_pack.receipt.json  # must be true

# Inspect policy applied
jq '.policy.expanded_allowlists' lab_pack.receipt.json

# Review attestations evaluated
jq '.attestations[] | {file: .attestation_file, ok: .policy_ok}' lab_pack.receipt.json
```

### External Auditor

```bash
# Verify Rekor log entry (public transparency)
cosign verify-blob --bundle lab_pack.receipt.json.sigstore.json lab_pack.receipt.json

# Extract OIDC identity from certificate
cosign verify-blob --bundle lab_pack.receipt.json.sigstore.json lab_pack.receipt.json 2>&1 | grep "Issuer:"

# Expected: GitHub OIDC (workflow identity)
```

### Retrospective Analysis

```bash
# Compare receipts across multiple releases
for tag in v1.2.0 v1.2.1 v1.2.2 v1.2.3; do
  gh release download "$tag" --pattern "*.receipt.json" --dir "receipts/$tag"
done

# Analyze policy evolution
jq '.policy.expanded_allowlists' receipts/*/lab_pack.receipt.json
```

---

## Troubleshooting

### Receipt generation failed

```
ERROR: no attestations downloaded for <subject>
```

**Cause:** Subject file missing or attestations unavailable  
**Fix:** Ensure `gh attestation verify <subject>` works before policy engine

---

### Receipt signature verification failed

```
Error: verifying blob: invalid signature when validating ASN.1 encoded signature
```

**Cause:** Corrupted `.sigstore.json` bundle  
**Fix:** Re-download from release or check Rekor log directly

---

### Receipt shows `ok: false`

```json
{
  "result": {
    "ok": false,
    "reasons": ["configSource.uri not allowed: ..."]
  }
}
```

**Cause:** Policy violation detected  
**Fix:** Inspect `result.reasons` for specific constraint failures

---

## Receipt Lifecycle

```
[Policy Engine Run] → receipt.json (deterministic)
         ↓
[Cosign Sign] → receipt.json.sigstore.json (keyless)
         ↓
[Upload to Release] → GitHub Release asset
         ↓
[Download by auditor] → Local verification
         ↓
[Cosign Verify] → Signature valid (Rekor log)
         ↓
[Parse result.ok] → Audit conclusion
```

---

## Optional: GitHub Attestations for Receipts

Receipts can be **attested as build artifacts** for extra provenance:

```yaml
- name: Attest policy receipts (optional - 11.7.5)
  uses: actions/attest-build-provenance@v2
  with:
    subject-path: |
      policy_receipts/*.receipt.json
      policy_receipts/*.receipt.json.sigstore.json
```

Verify receipt attestations:

```bash
gh attestation verify lab_pack.receipt.json --owner OWNER
```

This creates a **provenance → receipt → attestation chain** for maximum auditability.

---

## CLI Flags Reference

| Flag | Default | Purpose |
|------|---------|---------|
| `--receipt-out` | (empty) | Write receipt to this path (no-op if empty) |
| `--receipt-mode` | `single` | `single` = overwrite, `append` = JSONL |
| `--receipt-include-attestation-snippets` | (disabled) | Include truncated attestation excerpts |

---

## Summary

Policy receipts provide:

✅ **Machine-readable proof** of policy compliance  
✅ **Cryptographic signatures** (tamper-evident)  
✅ **Portable audit artifacts** (works offline)  
✅ **Deterministic evaluation** (reproducible)  
✅ **Transparency** (Rekor public log)  

External auditors can independently verify release compliance without access to CI/CD secrets or GitHub org.

---

**Version:** Phase 11.7.5  
**Last Updated:** 2025-02-02
